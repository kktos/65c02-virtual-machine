<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>65C02 VM Debugger (Vue 3)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['SFMono-Regular', 'Menlo', 'monospace'],
                    },
                    colors: {
                        'gray-900': '#111827',
                        'gray-800': '#1f2937',
                        'gray-700': '#374151',
                        'cyan-400': '#22d3ee',
                        'indigo-300': '#a5b4fc',
                        'yellow-300': '#fde047',
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Style for fixed-width data/address input */
        .tabular-nums {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="bg-gray-900">

<div id="app" class="min-h-screen bg-gray-900 text-white p-4 antialiased">
    <!-- Main Vue App will be mounted here -->
</div>

<!-- Load Vue 3 -->
<script src="https://unpkg.com/vue@3"></script>

<script type="module">
    import { createApp, ref, computed, onMounted, defineComponent, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';

    // --- LLM Constants and Utilities (Outside Vue component definitions) ---
    const API_KEY = ""; 
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    const retryFetch = async (url, options, retries = 3) => {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && i < retries - 1) { // Too Many Requests
                        const delayTime = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await delay(delayTime);
                        continue;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                if (i === retries - 1) throw error;
                const delayTime = Math.pow(2, i) * 1000 + Math.random() * 1000;
                await delay(delayTime);
            }
        }
    };

    // --- Utility Component: DebuggerPanelTitle ---
    const DebuggerPanelTitle = {
        props: ['title'],
        template: `
            <h2 class="text-sm font-semibold text-cyan-400 border-b border-gray-700/50 pb-2 mb-3 uppercase tracking-wider">
                {{ title }}
            </h2>
        `
    };

    // --- Utility Function: useLabeling ---
    const useLabeling = () => {
        const LABELS = {
            0x0200: 'INPUTBUF',
            0x0400: 'TXT_SCRN_START',
            0xC000: 'KBD_STROBE',
            0xFCE2: 'INIT_SYSTEM',
        };

        const getLabeledInstruction = (opcode) => {
            const addressMatch = opcode.match(/\$([0-9A-Fa-f]{2,4}[\w,()]?)/);
            
            if (addressMatch) {
                const fullAddressExpression = addressMatch[0];
                const addressHexMatch = fullAddressExpression.match(/([0-9A-Fa-f]{2,4})/);
                if (addressHexMatch) {
                    const addressHex = addressHexMatch[1];
                    const address = parseInt(addressHex, 16);
                    
                    if (LABELS[address]) {
                        const label = LABELS[address];
                        // Replace the address part with the label, keeping the addressing mode suffix
                        const suffix = fullAddressExpression.substring(addressHexMatch[0].length);
                        const newOpcode = opcode.replace(fullAddressExpression, label + suffix);
                        const comment = `$${addressHex.toUpperCase().padStart(4, '0')}`;
                        return { labeledOpcode: newOpcode, labelComment: comment };
                    }
                }
            }
            
            return { labeledOpcode: opcode, labelComment: null };
        };
        return getLabeledInstruction;
    };


    // --- 1. Debugger Controls Component ---
    const DebuggerControls = {
        props: ['isRunning', 'handleRunPause', 'handleStepInstruction', 'handleStepOver', 'handleStepOut', 'handleReset'],
        template: `
            <div class="flex justify-start items-center space-x-4 mb-6 p-3 bg-gray-800 rounded-xl shadow-inner border border-gray-700 shrink-0">
                
                <!-- Run / Pause / Stop -->
                <button
                    @click="handleRunPause"
                    :class="['flex items-center space-x-1 text-sm px-3 py-1.5 rounded-lg font-semibold transition duration-200 shadow-md whitespace-nowrap', isRunning ? 'bg-red-600 hover:bg-red-500' : 'bg-green-600 hover:bg-green-500', 'text-white']"
                >
                    {{ isRunning ? '⏸️ Pause' : '▶️ Run' }}
                </button>

                <!-- Separator -->
                <div class="w-[1px] bg-gray-600 my-1"></div>

                <!-- Step Controls -->
                <!-- Step Into (alias for Step Instruction) -->
                <button
                    @click="handleStepInstruction"
                    :disabled="isRunning"
                    :class="['text-sm px-3 py-1.5 rounded-lg font-semibold transition duration-200 shadow-md whitespace-nowrap bg-gray-700 hover:bg-gray-600 text-gray-200 disabled:opacity-50']"
                    title="Execute the current instruction, stepping into subroutines (JSR)"
                >
                    Step Into
                </button>
                
                <!-- Step Over -->
                <button
                    @click="handleStepOver"
                    :disabled="isRunning"
                    :class="['text-sm px-3 py-1.5 rounded-lg font-semibold transition duration-200 shadow-md whitespace-nowrap bg-gray-700 hover:bg-gray-600 text-gray-200 disabled:opacity-50']"
                    title="Execute the current instruction. If JSR, run until return address."
                >
                    Step Over
                </button>
                
                <!-- Step Out (Exit Sub) -->
                <button
                    @click="handleStepOut"
                    :disabled="isRunning"
                    :class="['text-sm px-3 py-1.5 rounded-lg font-semibold transition duration-200 shadow-md whitespace-nowrap bg-gray-700 hover:bg-gray-600 text-gray-200 disabled:opacity-50']"
                    title="Run program until the next RTS or RTI (Return from Subroutine/Interrupt)"
                >
                    Step Out
                </button>
                
                <!-- Separator -->
                <div class="w-[1px] bg-gray-600 my-1"></div>

                <!-- Reset -->
                <button
                    @click="handleReset"
                    :class="['text-sm px-3 py-1.5 rounded-lg font-semibold transition duration-200 shadow-md whitespace-nowrap bg-gray-700 hover:bg-gray-600 text-gray-200 disabled:opacity-50']"
                    title="Reset the CPU and memory"
                >
                    Reset
                </button>
            </div>
        `
    };

    // --- 2. Register View Component ---
    const RegisterView = {
        components: { DebuggerPanelTitle },
        props: ['registers', 'controls'],
        setup(props) {
            const registerOrder = ['A', 'X', 'Y', 'SP', 'PC'];

            const handleRegisterChange = (reg, event) => {
                const rawValue = event.target.value.replace('$', ''); // Remove leading $
                const value = parseInt(rawValue, 16);
                
                const maxValue = reg === 'PC' ? 0xFFFF : 0xFF;

                if (!isNaN(value) && value >= 0 && value <= maxValue) {
                    props.controls.updateRegister(reg, value);
                    // NOTE: In a real Vue app, the parent state (emulatorState.registers) would update the prop automatically.
                }
            };

            return { registerOrder, handleRegisterChange };
        },
        template: `
            <div class="p-4 bg-gray-800 rounded-lg shadow-xl">
                <DebuggerPanelTitle title="Registers" />
                <div class="flex flex-col space-y-2">
                    <div v-for="key in registerOrder" :key="key" class="flex items-center justify-between space-x-2">
                        <span class="text-gray-300 font-mono text-base font-bold w-10">{{ key }}:</span>
                        <input
                            type="text"
                            :value="registers ? '$' + registers[key].toString(16).toUpperCase().padStart(key === 'PC' ? 4 : 2, '0') : '$----'"
                            @input="handleRegisterChange(key, $event)"
                            :maxLength="key === 'PC' ? 4 : 2"
                            :class="[
                                'text-right font-mono text-base rounded-md px-2 py-1 transition duration-150 border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 tabular-nums',
                                key === 'PC' ? 'bg-indigo-900 text-white w-24' : 'bg-gray-700 text-yellow-300 w-20'
                            ]"
                        />
                    </div>
                </div>
            </div>
        `
    };

    // --- 3. Status Flags View Component ---
    const StatusFlagsView = {
        components: { DebuggerPanelTitle },
        props: ['registers', 'controls'],
        setup(props) {
            const flags = [
                { name: 'N (Negative)', key: 'N' }, { name: 'V (Overflow)', key: 'V' },
                { name: '-', key: 'U' }, { name: 'B (Break)', key: 'B' },
                { name: 'D (Decimal)', key: 'D' }, { name: 'I (Interrupt)', key: 'I' },
                { name: 'Z (Zero)', key: 'Z' }, { name: 'C (Carry)', key: 'C' }
            ];

            const handleFlagToggle = (key) => {
                if (key !== 'U') {
                    console.log(`Toggling flag ${key}`);
                    // In a real app, logic would calculate new P register value and call controls.updateRegister('P', new_status_byte);
                }
            };

            return { flags, handleFlagToggle };
        },
        template: `
            <div class="p-4 bg-gray-800 rounded-lg shadow-xl">
                <DebuggerPanelTitle title="Status Flags" />
                <div class="grid grid-cols-4 gap-2">
                    <button
                        v-for="{ name, key } in flags"
                        :key="key"
                        @click="handleFlagToggle(key)"
                        :disabled="key === 'U'"
                        :class="[
                            'p-2 text-xs rounded-full shadow-md font-medium transition duration-150',
                            (registers && registers[key]) ? 'bg-green-600 text-white hover:bg-green-500' : 'bg-gray-600 text-gray-300 hover:bg-gray-500',
                            key === 'U' ? 'opacity-50 cursor-not-allowed' : ''
                        ]"
                        :title="name"
                    >
                        {{ key }}
                    </button>
                </div>
            </div>
        `
    };

    // --- 4. Disassembly View Component ---
    const DisassemblyView = {
        components: { DebuggerPanelTitle },
        props: ['disassembly', 'PC', 'registers', 'onExplainCode'],
        setup(props) {
            const explanation = ref(null);
            const isLoading = ref(false);
            const getLabeledInstruction = useLabeling();
            
            // --- CRITICAL DEBUGGING LOG ---
            console.log("DisassemblyView received data. Type:", typeof props.disassembly, "Length:", props.disassembly ? props.disassembly.length : 0);
            if (props.disassembly && !Array.isArray(props.disassembly)) {
                console.warn("Disassembly prop received is NOT an array inside Vue runtime. Received:", props.disassembly);
            }
            // -----------------------------


            const getBranchPrediction = (opcode) => {
                // Defensive check for props.registers (already added in last iteration, keeping it)
                if (!props.registers) return null;

                const { N, Z, C, V } = props.registers;
                let isTaken = false;

                if (opcode.startsWith('BNE')) isTaken = !Z;
                else if (opcode.startsWith('BEQ')) isTaken = Z;
                else if (opcode.startsWith('BPL')) isTaken = !N;
                else if (opcode.startsWith('BMI')) isTaken = N;
                else if (opcode.startsWith('BCC')) isTaken = !C;
                else if (opcode.startsWith('BCS')) isTaken = C;
                else if (opcode.startsWith('BVC')) isTaken = !V;
                else if (opcode.startsWith('BVS')) isTaken = V;

                if (opcode.startsWith('B') && !['BRK', 'BIT'].includes(opcode)) {
                    if (isTaken) {
                        return { char: '→', title: 'Branch Taken', color: 'text-green-400' };
                    } else {
                        return { char: '↓', title: 'Branch Not Taken', color: 'text-red-400' };
                    }
                }
                return null;
            };

            const handleExplain = async () => {
                isLoading.value = true;
                explanation.value = null;

                // Ensure disassembly is treated as an array for mapping
                const codeArray = Array.isArray(props.disassembly) ? props.disassembly : [];
                
                const codeBlock = codeArray.map(line => {
                    const { labeledOpcode, labelComment } = getLabeledInstruction(line.opcode);
                    const finalComment = line.comment || (labelComment ? `; ${labelComment}` : '');
                    
                    const addr = `$${line.address.toString(16).toUpperCase().padStart(4, '0')}`;
                    const bytes = line.rawBytes.padEnd(6, ' ');
                    const op = labeledOpcode.padEnd(20, ' ');
                    
                    return `${addr} ${bytes} ${op} ${finalComment}`;
                }).join('\n');

                await props.onExplainCode(codeBlock, explanation, isLoading);
            };

            return { explanation, isLoading, getLabeledInstruction, getBranchPrediction, handleExplain };
        },
        template: `
            <div class="p-4 bg-gray-800 rounded-lg shadow-xl h-full flex flex-col">
                <!-- Header combining title, count, and action button -->
                <div class="flex justify-between items-center mb-3 border-b border-gray-700/50 pb-2 shrink-0">
                    <h2 class="text-sm font-semibold text-cyan-400 uppercase tracking-wider">
                        Disassembly <span class="text-gray-400 font-normal">({{ disassembly && disassembly.length || 0 }} Instructions)</span>
                    </h2>
                    
                    <button
                        @click="handleExplain"
                        :disabled="isLoading || (disassembly && disassembly.length === 0)"
                        class="text-xs px-3 py-1 rounded-full bg-indigo-600 text-white hover:bg-indigo-500 transition duration-150 shadow-md flex items-center disabled:opacity-50"
                    >
                        {{ isLoading ? 'Analyzing...' : 'Explain Code Block ✨' }}
                    </button>
                </div>
                
                <!-- Explanation Result Panel -->
                <div v-if="explanation" class="mb-3 p-3 bg-gray-700 rounded-lg text-sm text-gray-200 shadow-inner shrink-0">
                    <p class="font-semibold text-cyan-400 mb-1">AI Analysis:</p>
                    <p class="whitespace-pre-wrap">{{ explanation }}</p>
                </div>

                <!-- Scrollable disassembly table -->
                <div class="font-mono text-xs overflow-y-auto flex-grow min-h-0 bg-gray-900 p-2 rounded-md"> 
                    <p v-if="!disassembly || disassembly.length === 0" class="text-gray-500 italic p-4 text-center">
                        Disassembly data is empty or unavailable. (Check console for debug logs)
                    </p>
                    <table v-else class="w-full">
                        <thead>
                            <tr class="text-gray-400 sticky top-0 bg-gray-900 border-b border-gray-700 shadow-md">
                                <th class="py-1 text-left px-2 w-16">Addr</th>
                                <th class="py-1 text-left w-20">Raw Bytes</th>
                                <th class="py-1 text-left w-36">Opcode</th>
                                <th class="py-1 text-left flex-grow">Comment</th>
                                <th class="py-1 text-right w-12">Cycles</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr
                                v-for="(line, index) in disassembly"
                                :key="index"
                                :class="[
                                    'hover:bg-gray-700 transition duration-100',
                                    line.address === PC ? 'bg-yellow-800/70 text-yellow-100 font-bold border-l-4 border-yellow-400' : 'text-gray-300'
                                ]"
                            >
                                <td class="py-0.5 px-2 tabular-nums text-indigo-300">
                                    {{ '$' + line.address.toString(16).toUpperCase().padStart(4, '0') }}
                                </td>
                                <td class="py-0.5 tabular-nums text-gray-400">
                                    {{ line.rawBytes }}
                                </td>
                                <td class="py-0.5 text-left flex items-center">
                                    <span>{{ getLabeledInstruction(line.opcode).labeledOpcode }}</span>
                                    <span v-if="line.address === PC && getBranchPrediction(line.opcode)" 
                                        :class="['font-bold ml-2 text-base', getBranchPrediction(line.opcode).color]" 
                                        :title="getBranchPrediction(line.opcode).title">
                                        {{ getBranchPrediction(line.opcode).char }}
                                    </span>
                                </td>
                                <td class="py-0.5 text-left text-gray-500 italic">
                                    {{ line.comment || (getLabeledInstruction(line.opcode).labelComment ? '; ' + getLabeledInstruction(line.opcode).labelComment : '') }}
                                </td>
                                <td class="py-0.5 text-right text-gray-400">
                                    {{ line.cycles }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `
    };

    // --- 5. Memory Viewer Component ---
    const MemoryViewer = {
        props: ['memory', 'controls'],
        setup(props) {
            const startAddress = ref(0x0200);
            const MEMORY_LINES = 10;
            const BYTES_PER_LINE = 16;

            const handleAddressChange = (event) => {
                const value = parseInt(event.target.value, 16);
                if (!isNaN(value) && value >= 0 && value <= 0xFFFF) {
                    startAddress.value = value;
                }
            };

            const handleByteChange = (index, event) => {
                const value = parseInt(event.target.value, 16);
                if (!isNaN(value) && value >= 0 && value <= 0xFF) {
                    props.controls.updateMemory(startAddress.value + index, value);
                    // NOTE: memory should be a reactive array that updates automatically
                }
            };

            const currentMemorySlice = computed(() => {
                const start = startAddress.value;
                const end = start + MEMORY_LINES * BYTES_PER_LINE;
                // Added a safety check for memory length
                if (!props.memory || props.memory.length < end) return [];
                return props.memory.slice(start, end);
            });
            
            const bytesToAscii = (bytes) => {
                return bytes.map(byte => {
                    if (byte >= 32 && byte <= 126) {
                        return String.fromCharCode(byte);
                    }
                    return '.';
                }).join('');
            };

            return { startAddress, MEMORY_LINES, BYTES_PER_LINE, handleAddressChange, handleByteChange, currentMemorySlice, bytesToAscii };
        },
        template: `
            <div class="p-4 bg-gray-800 rounded-lg shadow-xl h-full flex flex-col">
                <div class="mb-3 mt-1 flex items-center space-x-2 shrink-0">
                    <span class="text-gray-300 text-sm">Start Address:</span>
                    <input
                        type="text"
                        :value="startAddress.toString(16).toUpperCase().padStart(4, '0')"
                        @input="handleAddressChange"
                        class="bg-gray-700 text-yellow-300 font-mono text-sm rounded-md px-2 py-1 w-20 border border-gray-600 focus:ring-2 focus:ring-cyan-500 tabular-nums"
                    />
                </div>

                <div class="font-mono text-xs overflow-y-auto flex-grow min-h-0 bg-gray-900 p-2 rounded-md">
                    <table class="w-full table-fixed">
                        <thead>
                            <tr class="text-gray-400 sticky top-0 bg-gray-900 border-b border-gray-700 shadow-md">
                                <th class="py-1 text-left w-16">Addr</th>
                                <th v-for="i in BYTES_PER_LINE" :key="i" class="text-center w-[1.75rem]">{{ '+' + (i - 1).toString(16).toUpperCase() }}</th>
                                <th class="py-1 text-left w-auto pl-4">ASCII</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="lineIndex in MEMORY_LINES" :key="lineIndex" class="hover:bg-gray-700/50 transition duration-100 text-gray-300">
                                <td class="py-0.5 text-left text-indigo-300 font-bold">
                                    {{ '$' + (startAddress + (lineIndex - 1) * BYTES_PER_LINE).toString(16).toUpperCase().padStart(4, '0') }}
                                </td>
                                
                                <td v-for="byteIndex in BYTES_PER_LINE" :key="byteIndex" class="p-0">
                                    <input
                                        type="text"
                                        :value="currentMemorySlice[(lineIndex - 1) * BYTES_PER_LINE + (byteIndex - 1)].toString(16).toUpperCase().padStart(2, '0')"
                                        @input="handleByteChange((lineIndex - 1) * BYTES_PER_LINE + (byteIndex - 1), $event)"
                                        maxlength="2"
                                        class="w-full text-center bg-transparent focus:bg-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 rounded-none tabular-nums text-xs"
                                    />
                                </td>
                                
                                <td class="py-0.5 text-left text-green-300 font-bold pl-4 whitespace-nowrap">
                                    {{ bytesToAscii(currentMemorySlice.slice((lineIndex - 1) * BYTES_PER_LINE, lineIndex * BYTES_PER_LINE)) }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `
    };

    // --- 6. Stack View Component ---
    const StackView = {
        components: { DebuggerPanelTitle },
        props: ['stackData', 'controls', 'registers'],
        setup(props) {
            const stackBase = 0x0100;

            // Defensive check for props.registers in computed property
            const stackPointerAddress = computed(() => {
                if (props.registers && typeof props.registers.SP === 'number') {
                    return stackBase + props.registers.SP;
                }
                return stackBase; 
            });

            const stackSlice = computed(() => {
                // Read $01F0 to $01FF and reverse the order for top-down display
                // Safety check for stackData length
                if (!props.stackData || props.stackData.length < 0x100) return [];
                return [...props.stackData].slice(0xf0, 0x100).reverse();
            });

            const handleByteChange = (addr, event) => {
                const value = parseInt(event.target.value, 16);
                if (!isNaN(value) && value >= 0 && value <= 0xFF) {
                    props.controls.updateMemory(addr, value);
                }
            };

            return { stackBase, stackPointerAddress, stackSlice, handleByteChange };
        },
        template: `
            <div class="p-4 bg-gray-800 rounded-lg shadow-xl h-full flex flex-col">
                <DebuggerPanelTitle title="Stack ($0100 - $01FF)" />
                <div class="font-mono text-xs overflow-y-auto flex-grow min-h-0 bg-gray-900 p-2 rounded-md">
                    <table class="w-full">
                        <thead>
                            <tr class="text-gray-400 sticky top-0 bg-gray-900 border-b border-gray-700 shadow-md">
                                <th class="py-1 text-left px-2 w-1/4">Addr</th>
                                <th class="py-1 text-left">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr
                                v-for="(value, index) in stackSlice"
                                :key="index"
                                :class="[
                                    'hover:bg-gray-700/50 transition duration-100',
                                    (stackBase + 0xFF - index) === stackPointerAddress ? 'bg-indigo-900/50 text-indigo-100 font-bold border-l-4 border-indigo-400' : 'text-gray-300'
                                ]"
                            >
                                <td class="py-0.5 px-2 tabular-nums text-indigo-300">
                                    {{ '$' + (stackBase + 0xFF - index).toString(16).toUpperCase().padStart(4, '0') }}
                                </td>
                                <td class="p-0">
                                    <input
                                        type="text"
                                        :value="value.toString(16).toUpperCase().padStart(2, '0')"
                                        @input="handleByteChange((stackBase + 0xFF - index), $event)"
                                        maxlength="2"
                                        class="w-full text-left bg-transparent focus:bg-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 rounded-none tabular-nums"
                                    />
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `
    };

    // --- 7. Breakpoints List Component ---
    const BreakpointsList = {
        props: ['breakpoints', 'onRemoveBreakpoint', 'onAddBreakpoint'],
        setup(props) {
            const handleAddBreakpoint = () => {
                console.log("Simulating adding a new memory access breakpoint at $0700."); 
                const newBp = { address: 0x0700, type: 'Access' };
                props.onAddBreakpoint(newBp);
            };

            const getTypeStyles = (type) => {
                switch (type) {
                    case 'PC': return { bg: 'bg-indigo-600', border: 'border-indigo-400' };
                    case 'Write': return { bg: 'bg-red-600', border: 'border-red-400' };
                    case 'Read': return { bg: 'bg-yellow-600', border: 'border-yellow-400' };
                    case 'Access': return { bg: 'bg-green-600', border: 'border-green-400' };
                    default: return { bg: 'bg-gray-600', border: 'border-gray-500' };
                }
            };
            return { handleAddBreakpoint, getTypeStyles };
        },
        template: `
            <div class="p-4 bg-gray-800 rounded-lg shadow-xl h-full flex flex-col">
                <div class="flex justify-end items-center mb-3 border-b border-gray-700/50 pb-2 shrink-0 pt-1">
                    <DebuggerPanelTitle title="Breakpoints" />
                    <button
                        @click="handleAddBreakpoint"
                        class="text-xs px-2 py-1 rounded-full bg-cyan-600 text-white hover:bg-cyan-500 transition duration-150 shadow-md"
                    >
                        + Add BP (Mock)
                    </button>
                </div>
                <ul class="flex-grow min-h-0 space-y-2 overflow-y-auto text-sm text-gray-300 p-2 bg-gray-900 rounded-md">
                    <li v-if="breakpoints.length === 0" class="text-gray-500 italic p-2">No active breakpoints.</li>
                    <li
                        v-for="(bp, index) in breakpoints"
                        :key="bp.address + bp.type + index"
                        :class="['flex justify-between items-center p-2 bg-gray-700 rounded-md hover:bg-gray-600 transition duration-100 font-mono border-l-4', getTypeStyles(bp.type).border]"
                    >
                        <div class="flex items-center space-x-3">
                            <span :class="['px-2 py-0.5 text-xs font-semibold rounded-full min-w-[70px] text-center text-white', getTypeStyles(bp.type).bg]">
                                {{ bp.type }}
                            </span>
                            <span class="text-indigo-300">{{ '$' + bp.address.toString(16).toUpperCase().padStart(4, '0') }}</span>
                        </div>
                        <button
                            @click="onRemoveBreakpoint(bp)"
                            class="text-red-400 hover:text-red-300 text-lg p-1"
                            title="Remove Breakpoint"
                        >
                            &times;
                        </button>
                    </li>
                </ul>
            </div>
        `
    };

    // --- 8. Bottom Tab Panel Component ---
    const BottomTabPanel = {
        props: ['activeTab', 'setActiveTab'],
        // Using slots to render the content for better component isolation
        template: `
            <div class="flex flex-col h-full bg-gray-800 rounded-xl shadow-xl">
                <div class="flex border-b border-gray-700 px-4 shrink-0 bg-gray-900 rounded-t-xl">
                    <button
                        @click="setActiveTab('disassembly')"
                        :class="['px-4 py-3 text-sm font-medium transition duration-150', activeTab === 'disassembly' ? 'text-cyan-400 border-b-2 border-cyan-400' : 'text-gray-400 hover:text-white hover:bg-gray-700/50']"
                    >
                        Disassembly
                    </button>
                    <button
                        @click="setActiveTab('memory')"
                        :class="['px-4 py-3 text-sm font-medium transition duration-150', activeTab === 'memory' ? 'text-cyan-400 border-b-2 border-cyan-400' : 'text-gray-400 hover:text-white hover:bg-gray-700/50']"
                    >
                        Memory Viewer
                    </button>
                    <button
                        @click="setActiveTab('breakpoints')"
                        :class="['px-4 py-3 text-sm font-medium transition duration-150', activeTab === 'breakpoints' ? 'text-cyan-400 border-b-2 border-cyan-400' : 'text-gray-400 hover:text-white hover:bg-gray-700/50']"
                    >
                        Breakpoints
                    </button>
                </div>

                <div class="flex-grow min-h-0 p-1">
                    <slot :name="activeTab"></slot>
                </div>
            </div>
        `
    };


    // --- 9. Main App Component ---
    const App = {
        // FIX: Added DisassemblyView to the list of components for correct resolution
        components: { DebuggerControls, RegisterView, StatusFlagsView, StackView, MemoryViewer, BreakpointsList, BottomTabPanel, DebuggerPanelTitle, DisassemblyView }, 
        setup() {
            // --- State ---
            const isRunning = ref(false);
            const emulatorState = reactive({
                registers: {
                    A: 0x42, X: 0x01, Y: 0x02,
                    PC: 0x0609, 
                    SP: 0xF9, // Stack Pointer set to $F9
                    C: true, Z: false, I: true, D: false, B: false, V: false, N: false
                },
                memory: Array(0x10000).fill(0).map((_, i) => {
                    if (i >= 0x0200 && i < 0x0210) return "HELLO WORLD!!!".charCodeAt(i - 0x0200) || 0;
                    return (i % 256);
                }),
                disassembly: [
                    { address: 0x05FC, opcode: "LDA #$10", cycles: 2, rawBytes: "A9 10", comment: "Load character code" },
                    { address: 0x05FE, opcode: "JMP $FCE2", cycles: 3, rawBytes: "4C E2 FC", comment: "Jump to core handler" },
                    { address: 0x0600, opcode: "JSR $FCE2", cycles: 6, rawBytes: "20 E2 FC", comment: "Call initialization routine" },
                    { address: 0x0603, opcode: "LDX #$A0", cycles: 2, rawBytes: "A2 A0", comment: "Set loop counter (160 iterations)" },
                    { address: 0x0605, opcode: "STA $0200,X", cycles: 4, rawBytes: "9D 00 02", comment: "Write A to memory" }, 
                    { address: 0x0608, opcode: "DEX", cycles: 2, rawBytes: "CA", comment: "Decrement counter X" },
                    { address: 0x0609, opcode: "BNE $0605", cycles: 3, rawBytes: "D0 FB", comment: "Loop if X != 0 (Z is clear)" }, 
                    { address: 0x060B, opcode: "LDA $C000", cycles: 6, rawBytes: "AD 00 C0", comment: "Poll keyboard status" }, 
                    { address: 0x060E, opcode: "NOP", cycles: 2, rawBytes: "EA", comment: "" },
                    { address: 0x060F, opcode: "INC $02", cycles: 5, rawBytes: "E6 02", comment: "Increment Zero Page variable" },
                    { address: 0x0611, opcode: "EOR $0400", cycles: 5, rawBytes: "4D 00 04", comment: "XOR with screen byte" }, 
                    { address: 0x0614, opcode: "CMP #$00", cycles: 2, rawBytes: "C9 00", comment: "Compare A with zero" },
                    { address: 0x0616, opcode: "BEQ $0600", cycles: 3, rawBytes: "F0 E8", comment: "Branch if Equal (Z is set)" },
                ],
                breakpoints: [
                    { address: 0x0609, type: 'PC' }, 
                    { address: 0x0800, type: 'Write' },
                    { address: 0x01F0, type: 'Read' },
                    { address: 0x0200, type: 'Access' },
                ],
            });

            const activeTab = ref('disassembly');

            // --- Split View State ---
            const splitWidth = ref(60); // Percentage width of the left panel (Canvas)
            const MIN_SPLIT_WIDTH = 40;
            const MAX_SPLIT_WIDTH = 80;


            // --- Mock Controls/Worker ---
            const controls = {
                play: () => console.log('Worker: Run'),
                pause: () => console.log('Worker: Pause'),
                step: () => console.log('Worker: Step Instruction'),
                reset: () => console.log('Worker: Reset'),
                updateMemory: (addr, value) => {
                    emulatorState.memory[addr] = value; // Immediate update for demo
                    console.log(`Worker: Update [${addr.toString(16)}] to ${value.toString(16)}`);
                },
                updateRegister: (reg, value) => {
                    emulatorState.registers[reg] = value;
                    console.log(`Worker: Update Register ${reg} to ${value.toString(16)}`);
                },
            };

            // --- Handlers ---
            const handleRunPause = () => {
                if (isRunning.value) {
                    controls.pause();
                } else {
                    controls.play();
                }
                isRunning.value = !isRunning.value;
            };

            const handleStepInstruction = () => {
                controls.step();
                // Mock state update
                emulatorState.registers.PC += (isRunning.value ? 0 : 3); 
                emulatorState.registers.X = emulatorState.registers.X === 0 ? 0 : emulatorState.registers.X - 1;
                emulatorState.registers.Z = emulatorState.registers.X === 0;
            };

            const handleStepOver = () => {
                console.log("Control: Step Over command sent (MOCK).");
            };

            const handleStepOut = () => {
                console.log("Control: Step Out command sent (MOCK).");
            };

            const handleReset = () => {
                controls.reset();
                isRunning.value = false;
                // Reset to default
                emulatorState.registers.A = 0x00;
                emulatorState.registers.X = 0x00;
                emulatorState.registers.Y = 0x00;
                emulatorState.registers.PC = 0xC000;
                emulatorState.registers.SP = 0xFF;
                emulatorState.registers.C = false;
                emulatorState.registers.Z = false;
                emulatorState.registers.I = false;
                emulatorState.registers.D = false;
                emulatorState.registers.B = false;
                emulatorState.registers.V = false;
                emulatorState.registers.N = false;
            };
            
            const handleRemoveBreakpoint = (bpToRemove) => {
                emulatorState.breakpoints = emulatorState.breakpoints.filter(bp => !(bp.address === bpToRemove.address && bp.type === bpToRemove.type));
            };

            const handleAddBreakpoint = (newBp) => {
                const exists = emulatorState.breakpoints.some(bp => bp.address === newBp.address && bp.type === newBp.type);
                if (!exists) {
                    emulatorState.breakpoints.push(newBp);
                } else {
                    console.warn(`Breakpoint of type ${newBp.type} already exists at $${newBp.address.toString(16).toUpperCase()}`);
                }
            };

            // --- LLM Handler (Code Explanation) ---
            const handleExplainCode = async (codeBlock, setExplanation, setIsLoading) => {
                const systemPrompt = "You are a world-class 6502 CPU reverse engineer and assembly language expert. Analyze the provided block of 6502 assembly code and provide a concise, single-paragraph explanation of its overall purpose and function, focusing on the high-level logic (e.g., 'This loop copies X bytes from address A to address B').";
                const userQuery = `Analyze this 6502 assembly code block and explain its function: \n\n${codeBlock}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const result = await retryFetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        setExplanation.value = text;
                    } else {
                        setExplanation.value = "Could not retrieve explanation. API response was empty or malformed.";
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    setExplanation.value = "Error: Failed to connect to the analysis engine.";
                } finally {
                    setIsLoading.value = false;
                }
            };


            // --- Split View Logic ---
            const handleMouseMove = (e) => {
                const container = document.getElementById('main-container');
                if (!container) return;

                const newWidthPx = e.clientX - container.offsetLeft;
                const totalWidthPx = container.clientWidth;
                const newWidthPercent = (newWidthPx / totalWidthPx) * 100;

                if (newWidthPercent >= MIN_SPLIT_WIDTH && newWidthPercent <= MAX_SPLIT_WIDTH) {
                    splitWidth.value = newWidthPercent;
                }
            };

            const handleMouseUp = () => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
            };

            const handleMouseDown = (e) => {
                e.preventDefault();
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            };

            onMounted(() => {
                // Initial setup tasks if needed
            });

            return {
                isRunning,
                emulatorState,
                controls,
                activeTab,
                setActiveTab: (tab) => activeTab.value = tab,
                splitWidth,
                handleMouseDown,
                handleRunPause,
                handleStepInstruction,
                handleStepOver,
                handleStepOut,
                handleReset,
                handleRemoveBreakpoint,
                handleAddBreakpoint,
                handleExplainCode,
            };
        },
        template: `
            <div class="max-w-7xl mx-auto">
                <header class="mb-4 border-b border-gray-700 pb-3">
                    <h1 class="text-3xl font-extrabold text-cyan-400">65C02 VM Debugger (Vue 3)</h1>
                    <p class="text-gray-400 text-sm">Emulation Core: Web Worker | UI Framework: Vue 3/Tailwind</p>
                </header>

                <div id="main-container" class="flex flex-row h-[calc(100vh-120px)] overflow-hidden rounded-xl shadow-2xl border border-gray-700">

                    <!-- Left Panel: Canvas -->
                    <section class="p-4 flex flex-col space-y-4 bg-gray-800 transition-width duration-100" :style="{ width: splitWidth + '%' }">
                        <div class="flex-grow flex flex-col min-h-0 space-y-4">
                            <div class="flex-grow bg-gray-900 rounded-lg overflow-hidden flex items-center justify-center relative">
                                <canvas 
                                    id="vm-canvas" 
                                    class="w-full h-full object-contain" 
                                    style="image-rendering: pixelated;"
                                ></canvas>
                                <span class="absolute text-2xl text-green-500 font-mono opacity-20 pointer-events-none">VM Output</span>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Separator -->
                    <div 
                        class="w-2 cursor-col-resize bg-gray-700 hover:bg-cyan-500 transition duration-150 relative group"
                        @mousedown="handleMouseDown"
                    >
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-1 h-12 bg-gray-500 rounded-full group-hover:bg-cyan-300 transition-colors"></div>
                    </div>

                    <!-- Right Panel: Debugger Components -->
                    <section class="flex-grow bg-gray-900 flex flex-col p-4 overflow-hidden">
                        
                        <!-- 0. Debugger Controls at the Top (NEW LOCATION) -->
                        <DebuggerControls
                            :isRunning="isRunning"
                            :handleRunPause="handleRunPause"
                            :handleStepInstruction="handleStepInstruction"
                            :handleStepOver="handleStepOver"
                            :handleStepOut="handleStepOut"
                            :handleReset="handleReset"
                        />

                        <!-- 1. Top Section: Registers and Stack side-by-side -->
                        <div class="shrink-0 mb-6 grid grid-cols-3 gap-6"> 
                            
                            <!-- Registers and Flags stacked vertically in the first column (1/3) -->
                            <div class="col-span-1 flex flex-col space-y-6"> 
                                <RegisterView :registers="emulatorState.registers" :controls="controls" />
                                <StatusFlagsView :registers="emulatorState.registers" :controls="controls" />
                            </div>
                            
                            <!-- Stack View takes the remaining two columns (2/3) -->
                            <div class="col-span-2 h-full"> 
                                <StackView :stackData="emulatorState.memory" :controls="controls" :registers="emulatorState.registers" />
                            </div>
                        </div>
                        
                        <!-- 2. Bottom Section: Tabbed Panel -->
                        <div class="flex-grow min-h-0">
                            <BottomTabPanel :activeTab="activeTab" :setActiveTab="setActiveTab">
                                <template #disassembly>
                                    <DisassemblyView 
                                        :disassembly="emulatorState.disassembly" 
                                        :PC="emulatorState.registers.PC" 
                                        :registers="emulatorState.registers"
                                        :onExplainCode="handleExplainCode"
                                    />
                                </template>
                                <template #memory>
                                    <MemoryViewer :memory="emulatorState.memory" :controls="controls" />
                                </template>
                                <template #breakpoints>
                                    <BreakpointsList 
                                        :breakpoints="emulatorState.breakpoints" 
                                        :onRemoveBreakpoint="handleRemoveBreakpoint" 
                                        :onAddBreakpoint="handleAddBreakpoint" 
                                    />
                                </template>
                            </BottomTabPanel>
                        </div>
                    </section>
                </div>

            </div>
        `
    };

    // Mount the main App component
    createApp(App).mount('#app');
</script>
</body>
</html>
