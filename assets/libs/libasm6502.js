let e=class extends Error{constructor(...e){super(...e),this.name=this.constructor.name}};class t extends Error{constructor(...e){super(...e),this.name=this.constructor.name}}class n extends Error{constructor(...e){super(...e),this.name=this.constructor.name}}class s{constructor(e=null){this.type=e,this.value=null,this.text=null,this.posInLine=0,this.hasSpaceBefore=!1}toString(){const e=r(this.type);return`Token <${this.posInLine}:${e}${null!=this.value?` = ${this.value}`:""} - '${this.text}'>`}[Symbol.for("nodejs.util.inspect.custom")](e,t,n){return this.toString()}}function r(e){return E.find((([t,n])=>n===e))[0]}const o=[...Array(26)].map(((e,t)=>String.fromCharCode(t+65))),i=new Set([" ","\t"]),a=new Set(["0","1","2","3","4","5","6","7","8","9"]),c=new Set([...a,"A","B","C","D","E","F"]),l=new Set(["0","1"]),h=new Set([...o,"_"]),u=new Set([...h,...a]),x=new Set(["'",'"']),p={EOS:"EOS"},f={DOT:256,HASH:257,LEFT_PARENT:258,RIGHT_PARENT:259,COMMA:260,COLON:261,BANG:262,AT:263,LEFT_BRACKET:264,RIGHT_BRACKET:265,DOLLAR:336,PERCENT:337,IDENTIFIER:512,NUMBER:768,STRING:1024,ARRAY:1281,OBJECT:1282,REST:1283,LOWER:1536,GREATER:1537,EQUAL:1538,STAR:1539,SLASH:1540,PLUS:1541,MINUS:1542,AND:1543,OR:1544,BAND:1545,BOR:1546,BXOR:1547,INVALID:4095,EOF:32768},E=Object.entries(f),d={".":["..",f.REST,f.DOT],"#":f.HASH,"(":f.LEFT_PARENT,")":f.RIGHT_PARENT,",":f.COMMA,":":f.COLON,"!":f.BANG,"@":f.AT,"[":f.LEFT_BRACKET,"]":f.RIGHT_BRACKET,"&":["&",f.AND,f.BAND],"|":["|",f.OR,f.BOR],"^":f.BXOR,">":f.GREATER,"<":f.LOWER,"=":f.EQUAL,"*":f.STAR,"/":f.SLASH,"+":f.PLUS,"-":f.MINUS},k=new Set(Object.keys(d));class w{constructor(e){this.lines=e?e.split(/\r?\n/):[],this.lineIdx=0,this.states=[],this.eventHandlers={},this.nextLine()}nextLine(){this.currChar=null,this.posInLine=0,this.currLine=null,this.currToken=null,this.tokens=[],this.curTokIdx=0,this.tokCount=0,this.comment=null}}class T{constructor(){this.ctx=null,this.contexts=[]}pushSource(e){this.ctx&&this.contexts.push(this.ctx),this.ctx=new w(e)}addEventListener(e,t){if("function"!=typeof t)throw new TypeError("FATAL ERROR: Lexer.addEventListener needs a function");this.ctx.eventHandlers[e]||(this.ctx.eventHandlers[e]=[]),this.ctx.eventHandlers[e].push(t)}removeEventListener(e,t){if(!this.ctx.eventHandlers[e])return;const n=this.ctx.eventHandlers[e].indexOf(t);n>-1&&this.ctx.eventHandlers[e].splice(n,1)}executeEventListener(e){for(const t of this.ctx.eventHandlers[e])t()}stopSource(){this.ctx.lineIdx=this.ctx.lines.length}nextLine(){for(;this.ctx.nextLine(),!(this.ctx.lineIdx<this.ctx.lines.length);)if(this.ctx.eventHandlers[p.EOS]&&this.executeEventListener(p.EOS),this.ctx=this.contexts.pop(),!this.ctx)return!1;return this.ctx.currLine=this.ctx.lines[this.ctx.lineIdx++],this._tokenize(),!0}saveState(){this.ctx.states.push([this.ctx.lineIdx,this.ctx.posInLine,this.ctx.currLine,this.ctx.currChar])}restoreState(){[this.ctx.lineIdx,this.ctx.posInLine,this.ctx.currLine,this.ctx.currChar]=this.ctx.states.pop()}popState(){this.ctx.states.pop()}pos(){return{posInLine:this.ctx.posInLine,line:this.ctx.lineIdx}}line(){return this.ctx.currLine}eof(){return this.ctx.lineIdx>=this.ctx.lines.length}isLookahead(e){return!(this.ctx.curTokIdx>=this.ctx.tokCount-1)&&this.ctx.tokens[this.ctx.curTokIdx+1].type===e}lookahead(e=1){return e<0?!(this.ctx.tokCount-e<0)&&this.ctx.tokens[this.ctx.tokCount-e]:!(this.ctx.curTokIdx>=this.ctx.tokCount-e)&&this.ctx.tokens[this.ctx.curTokIdx+e]}isIdentifier(e){return this.ctx.curTokIdx<this.ctx.tokCount&&f.IDENTIFIER===this.ctx.tokens[this.ctx.curTokIdx].type&&e===this.ctx.tokens[this.ctx.curTokIdx].value}isToken(e){return this.ctx.curTokIdx<this.ctx.tokCount&&e===this.ctx.tokens[this.ctx.curTokIdx].type}match(e){return this.ctx.curTokIdx<this.ctx.tokCount&&e.includes(this.ctx.tokens[this.ctx.curTokIdx].type)}token(){return!(this.ctx.curTokIdx>=this.ctx.tokCount)&&this.ctx.tokens[this.ctx.curTokIdx]}next(){return this.ctx.curTokIdx++,this.ctx.curTokIdx<this.ctx.tokCount}eol(){return this.ctx.curTokIdx>=this.ctx.tokCount}_tokenize(){for(;this._advance();)this.ctx.tokens.push(this.ctx.currToken);this.ctx.tokCount=this.ctx.tokens.length}_nextChar(){if(this.ctx.posInLine>=this.ctx.currLine?.length)return this.ctx.currChar=null,null;this.ctx.currChar=this.ctx.currLine?.[this.ctx.posInLine++]??null}_testLookaheadChars(e){if(this.ctx.posInLine+e.length>=this.ctx.currLine?.length)return!1;let t=0;for(;t<e.length&&e[t]===this.ctx.currLine?.[this.ctx.posInLine+t].toUpperCase();)t++;return t===e.length}_testLookaheadChar(e){return!(this.ctx.posInLine>=this.ctx.currLine?.length)&&e.has(this.ctx.currLine?.[this.ctx.posInLine].toUpperCase()??null)}_lookaheadChar(e=0){return this.ctx.posInLine+e>=this.ctx.currLine?.length?null:this.ctx.currLine?.[this.ctx.posInLine+e]??null}_advance(){for(this.ctx.currToken=new s,this._nextChar();i.has(this.ctx.currChar);)this.ctx.currToken.hasSpaceBefore=!0,this._nextChar();if(null==this.ctx.currChar)return!1;if(this.ctx.currToken.posInLine=this.ctx.posInLine-1,k.has(this.ctx.currChar)){const e=d[this.ctx.currChar];if(this.ctx.currToken.text=this.ctx.currChar,!Array.isArray(e))return this.ctx.currToken.type=d[this.ctx.currChar],!0;const t=e[0];if(this._testLookaheadChars(t)){for(let e=t.length;0!==e;e--)this._nextChar();this.ctx.currToken.text+=t,this.ctx.currToken.type=e[1]}else this.ctx.currToken.type=e[2];return!0}let e=this.ctx.posInLine-1;if(h.has(this.ctx.currChar.toUpperCase())){for(;this._testLookaheadChar(u);)this._nextChar();return this.ctx.currToken.type=f.IDENTIFIER,this.ctx.currToken.text=this.ctx.currLine.slice(e,this.ctx.posInLine),this.ctx.currToken.value=this.ctx.currToken.text.toUpperCase(),!0}if("0"===this.ctx.currChar){let t=10,n=a;for("x"===this._lookaheadChar()&&(this._nextChar(),t=16,n=c,e+=2),"b"===this._lookaheadChar()&&(this._nextChar(),t=2,n=l,e+=2);this._testLookaheadChar(n);)this._nextChar();return this.ctx.currToken.type=f.NUMBER,this.ctx.currToken.text=this.ctx.currLine.slice(e,this.ctx.posInLine),this.ctx.currToken.value=parseInt(this.ctx.currToken.text,t),!0}if(a.has(this.ctx.currChar)){for(;this._testLookaheadChar(a);)this._nextChar();return this.ctx.currToken.type=f.NUMBER,this.ctx.currToken.text=this.ctx.currLine.slice(e,this.ctx.posInLine),this.ctx.currToken.value=parseInt(this.ctx.currToken.text),!0}if("$"===this.ctx.currChar){for(;this._testLookaheadChar(c);)this._nextChar();return this.ctx.posInLine-e==1?(this.ctx.currToken.type=f.DOLLAR,!0):(this.ctx.currToken.type=f.NUMBER,this.ctx.currToken.text=this.ctx.currLine.slice(e+1,this.ctx.posInLine),this.ctx.currToken.value=parseInt(this.ctx.currToken.text,16),!0)}if("%"===this.ctx.currChar){for(;this._testLookaheadChar(l);)this._nextChar();return this.ctx.posInLine-e==1?(this.ctx.currToken.type=f.PERCENT,!0):(this.ctx.currToken.type=f.NUMBER,this.ctx.currToken.text=this.ctx.currLine.slice(e+1,this.ctx.posInLine),this.ctx.currToken.value=parseInt(this.ctx.currToken.text,2),!0)}if(x.has(this.ctx.currChar)){this.saveState();const t=this.ctx.currChar;for(;null!=this._lookaheadChar()&&this._lookaheadChar()!==t;)this._nextChar();return null==this._lookaheadChar()?(this.restoreState(),null==this._lookaheadChar()?(this.ctx.currToken.type=f.INVALID,this.ctx.currToken.value=this.ctx.currChar,this.ctx.currToken.text=this.ctx.currChar,!1):(this._nextChar(),this.ctx.currToken.type=f.NUMBER,this.ctx.currToken.text=t+this.ctx.currChar,this.ctx.currToken.value=this.ctx.currChar.charCodeAt(0),!0)):(this.popState(),this._nextChar(),this.ctx.currToken.type=f.STRING,this.ctx.currToken.value=this.ctx.currLine.slice(e+1,this.ctx.posInLine-1),this.ctx.currToken.text=t+this.ctx.currToken.value+t,!0)}return";"===this.ctx.currChar?(this.comment=this.ctx.currLine.slice(e+1),!1):(this.ctx.currToken.type=f.INVALID,this.ctx.currToken.value=this.ctx.currChar,this.ctx.currToken.text=this.ctx.currChar,!1)}}function R(e){return e.toString(16).toUpperCase().padStart(2,"0")}function N(e){return e.toString(16).toUpperCase().padStart(4,"0")}function I(e){return 255&e}function y(e){switch(typeof e){case"number":return f.NUMBER;case"string":return f.STRING;case"object":return Array.isArray(e)?f.ARRAY:f.OBJECT;default:throw new t("Unknown data type : "+typeof e)}}class m{constructor(e){this.pc=0,this.obj={},this._output=null,null==e?(this.segments={CODE:{start:4096,end:65535}},this.currentSegment="CODE",this.obj[this.currentSegment]=[],this.pc=this.segments[this.currentSegment].start):(this.segments=e,this.currentSegment=null)}get output(){const e=this._output;return this._output=null,e}segment(){if(!this.currentSegment)throw new VAExprError("No segment defined");return{name:this.currentSegment,...this.segments[this.currentSegment]}}select(e){if(this.currentSegment=e,void 0===this.segments[this.currentSegment])throw new n("No such segment");void 0===this.obj[this.currentSegment]&&(this.obj[this.currentSegment]=[]),this.pc=this.segments[this.currentSegment].start+this.obj[this.currentSegment].length}setPC(e){const t=this.segments[this.currentSegment];if(e<t.start||e>t.end)throw new n(`ORG is out of Segment "${this.currentSegment}" range ${N(t.start)}:${N(t.end)}`);this.pc=e}reset(){this.pc=this.currentSegment?this.segments[this.currentSegment].start:0,this._output=null}emits(e,t,s){const r=this.obj[this.currentSegment];if(void 0===r)throw new n("No Object Segment set");const o=this.segments[this.currentSegment];if(this.pc+t.length>o.end+1)throw new n(`Code is out of Segment "${this.currentSegment}" range ${N(this.pc)}:${N(this.pc+t.length)} > ${N(o.start)}:${N(o.end)}`);if(e>1){let e="",n="";const i=this.pc-o.start,a=[];for(let o=0;o<t.length;o++)o%6==0&&(n+=`    ${N(this.pc+o)}: `),r[i+o]=I(t[o]),n+=` ${R(t[o])}`,s&&(e+=String.fromCharCode(t[o])),o%6==5&&(a.push(n.padEnd(32)+e),n="",e="");""!==n&&a.push(n.padEnd(32)+e),this._output=a.join("\n")}this.pc+=t.length}dump(e,t=16){const s=this.obj[e];if(void 0===s||!s.length)throw new n(`No Object Code for Segment ${e}`);let r="";const o=this.segments[e].start,i=o+s.length;for(let e=o-o%8;e<i;e++)e%t==0&&(r+=`${N(e)}: `),e<o?r+=".. ":(r+=R(void 0===s[e-o]?0:s[e-o]||0),r+=e%t==t-1||e===i-1?"\n":" ");console.log(r)}}const S="GLOBAL",v=Symbol("no symbol"),C=Symbol("overriden"),A=Symbol("markers");class O{constructor(){this.namespaces={},this.select(S),this.global=this.namespaces[S],this.exports={},this.nsStack=[]}get namespace(){return this.currentName}get isGlobal(){return this.currentName===S}export(e){this.global[e]=this.ns[e],this.exports[e]=this.currentName}exportMany(e){const t=new RegExp(e,"i"),n=Object.keys(this.ns).filter((e=>e.match(t)));return n.forEach((e=>{this.global[e]=this.ns[e],this.exports[e]=this.currentName})),n.length}set(e,t){this.ns[e]=t,this.exports[e]===this.currentName&&(this.global[e]=t)}get(e,t=null){return t?this.namespaces[t]?.[e]:this.ns[e]?this.ns[e]:this.global[e]}search(e){const t=[];return Object.keys(this.namespaces).forEach((n=>{this.namespaces[n][e]&&t.push(n)})),t}override(e,t){return this.ns[e]&&(this.ns[C]||(this.ns[C]={}),this.ns[C][e]||(this.ns[C][e]=[]),this.ns[C][e].push(this.ns[e])),this.set(e,t)}restore(e){const t=this.ns[C]?.[e]?.pop();if(t)return this.set(e,t);delete this.ns[e]}getCheap(e,t){let n=this.ns[e];return n||(n=this.ns[v]),{...n.cheaps[t]}}addCheap(e,t,n){let s=this.ns[e];return s||(this.ns[v]||(this.ns[v]={name:"NOSYMBOL"}),s=this.ns[v]),s.cheaps||(s.cheaps={}),!s.cheaps[t]&&(s.cheaps[t]={...n,cheap:!0},!0)}addMarker(e){this.get(A).push(e)}findClosestMarker(e,t){const n=this.get(A);let s=n.findIndex((t=>t>e));if(s<0){if(t>0)return null;s=n.length-1}else s=t<0?s+t:s-1+t;return n[s]}nsExists(e){return void 0!==this.namespaces[e]}exists(e,t=null){return t?Object.hasOwn(this.namespaces[t],e):Object.hasOwn(this.ns,e)||Object.hasOwn(this.global,e)}select(e){const t=e??S;this.namespaces[t]||(this.namespaces[t]={},this.namespaces[t][A]=[]),this.currentName&&this.nsStack.push(t),this.currentName=t,this.ns=this.namespaces[this.currentName]}nsPop(){this.nsStack.pop(),this.currentName=this.nsStack.slice(-1).shift(),this.ns=this.namespaces[this.currentName]}dump(){let e="";return Object.keys(this.namespaces).forEach((t=>{e+=`${t}:\n`;const n=this.namespaces[t];Object.keys(n).forEach((t=>{const s=n[t];if(e+=`  ${t}: `,e+=r(s.type).toLowerCase(),s.type===f.ARRAY)e+=` = ${s.value}\n`;else e+=` = $${s.value.toString(16).toUpperCase()}\n`}))})),e}}class b{constructor(e,t){this.filename=null,this.filepath=null,this.pass=1,this.lexerStack=[],this.wannaStop=!1,this.opcodes=null,this.cpu="??",this._readFile=e.readFile,this.YAMLparse=e.YAMLparse,this._mainFile=t,this.wannaListing=e.listing,this.charMap=null,this.macros={},this.console=e.console?e.console:console,globalThis.console=this.console,this.code=new m(e.segments),this.lexer=new T,this.symbols=new O,this.reset()}pushFile(e,n){const{path:s,content:r,error:o}=this._readFile(e,n);if(o)throw new t(o);this.lexerStack.push({filename:this.filename,filepath:this.filepath}),this.filename=e,this.filepath=s,this.lexer.pushSource(r),this.lexer.addEventListener(p.EOS,(()=>{const e=this.lexerStack.pop();e&&(this.filename=e.filename,this.filepath=e.filepath)}))}reset(){this.pushFile(this._mainFile),this.code.reset(),this._deferredMsg="",this.lastLabel=null,this.symbols.select()}print(e,t){t?this._deferredMsg+=e:this.pass<2||(this.wannaListing&&console.log(e),""!==this._deferredMsg&&(this.console.log(this._deferredMsg),this._deferredMsg=""))}warn(e){this.console.warn("WARNING",e)}error(e){const{posInLine:t,line:n}=this.lexer.pos(),s=this.lexer.line();this.console.error(`\n${e} in ${this.filepath} at line ${n} at ${t}\n${s?.slice(0,t)}<>${s?.slice(t+1)}`)}}function M(e,t){const n=t[0];let s;if("string"==typeof n){let[t,r]=n.toUpperCase().split(".");r||(r=t,t=null),s=e.symbols.exists(r,t)}else s=void 0!==n;return{value:s,type:f.NUMBER}}const L={allowUndef:!0};function g(e,t,n,s){s.forEach((s=>{B[s]={handlerFn:e,parmCount:t,flags:n}}))}const B={};function U(e,t,n){return B[t].handlerFn(e,n)}g(M,1,L,["DEF"]),g((function(e,t){const n=M(e,t);return n.value=!n.value,n}),1,L,["UNDEF"]),g((function(e,n){const s=n[0];if("number"!=typeof s)throw new t("HEX: Invalid Type "+typeof s);return{value:`$${s>255?N(s):R(s)}`,type:f.STRING}}),1,{},["HEX"]),g((function(e,n){const s=n[0];if(!Array.isArray(s)&&"string"!=typeof s)throw new t(`LEN: Invalid Type "${typeof s}"`);return{value:s.length,type:f.NUMBER}}),1,{},["LEN"]),g((function(e,t){const n=t[0];let s=typeof n;return Array.isArray(n)&&(s="array"),{value:s,type:f.STRING}}),1,{},["TYPE"]);const D=new Set([f.MINUS,f.PLUS]);function P(t,n,s){let r;const o={...t,stack:[],endSet:n};if(G(o),o.stack.length&&(r=$(t,o.stack)),t.pass<2)return r;if(s&&s!==r.type)throw new e("EXPR: Invalid type");return r}function $(t,n){const s=[];for(;n.length>1;){let r;for(;n.length&&(r=n.shift(),Array.isArray(r)&&(r=$(t,r)),!r.op);)s.push(r);switch(r.op){case"NEG":{const t=s.pop();if(t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:-t.value});break}case"*":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value*t.value});break}case"+":{const e=s.pop(),t=s.pop(),r=t.type===f.NUMBER||e.type===f.NUMBER?f.NUMBER:f.STRING;n.unshift({type:r,value:t.value+e.value});break}case"/":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value/t.value});break}case"-":{const r=s.pop(),o=s.pop();if(t.pass>1&&(o.type!==f.NUMBER||r.type!==f.NUMBER))throw console.log("EXPR SUB",o,r),new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:o.value-r.value});break}case"<":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value<t.value});break}case"<=":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value<=t.value});break}case">":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value>t.value});break}case">=":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value>=t.value});break}case"=":{const t=s.pop(),r=s.pop();if(r.type!==t.type){if(![r.type===f.NUMBER&&t.type===f.STRING,r.type===f.STRING&&t.type===f.NUMBER].some((e=>!0===e)))throw new e("Incompatible types for equality")}n.unshift({type:f.NUMBER,value:r.value===t.value});break}case"!=":{const t=s.pop(),r=s.pop();if(r.type!==t.type){if(![r.type===f.NUMBER&&t.type===f.STRING,r.type===f.STRING&&t.type===f.NUMBER].some((e=>!0===e)))throw new e("Incompatible types for inequality")}n.unshift({type:f.NUMBER,value:r.value!==t.value});break}case"!":{const t=s.pop();if(t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:!t.value});break}case"AND":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value&&t.value});break}case"OR":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value||t.value});break}case"BAND":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value&t.value});break}case"BOR":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value|t.value});break}case"BXOR":{const t=s.pop(),r=s.pop();if(r.type!==f.NUMBER||t.type!==f.NUMBER)throw new e("Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value^t.value});break}case"FN":{const e=[];let o=r.parmCount;for(;o--&&s.length;)e.unshift(s.pop().value);const i=U(t,r.fn,e);n.unshift(i);break}case"MSB":{const r=s.pop();if(t.pass>1&&r.type!==f.NUMBER)throw new e("MSB: Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:r.value>>8&255});break}case"LSB":{const r=s.pop();if(t.pass>1&&r.type!==f.NUMBER)throw new e("LSB: Only Numbers are allowed here");n.unshift({type:f.NUMBER,value:255&r.value});break}default:throw new e(`Unknown operation ${r.op}`)}}return n[0]}function G(e){let t;for(F(e);;)switch(t=e.lexer.token(),t.type){case f.AND:e.lexer.next(),F(e),e.stack.push({op:"AND"});break;case f.OR:e.lexer.next(),F(e),e.stack.push({op:"OR"});break;default:return}}function F(e){switch(_(e),e.lexer.token().type){case f.LOWER:{let t="<";e.lexer.next(),e.lexer.isToken(f.EQUAL)&&(t="<=",e.lexer.next()),_(e),e.stack.push({op:t});break}case f.GREATER:{let t=">";e.lexer.next(),e.lexer.isToken(f.EQUAL)&&(t=">=",e.lexer.next()),_(e),e.stack.push({op:t});break}case f.EQUAL:e.lexer.next(),_(e),e.stack.push({op:"="});break;case f.BANG:if(!e.lexer.isLookahead(f.EQUAL))return;e.lexer.next(),e.lexer.next(),_(e),e.stack.push({op:"!="});break;default:return}}function _(e){for(H(e);;)switch(e.lexer.token().type){case f.PLUS:e.lexer.next(),H(e),e.stack.push({op:"+"});break;case f.MINUS:e.lexer.next(),H(e),e.stack.push({op:"-"});break;default:return}}function H(e){for(X(e);;)switch(e.lexer.token().type){case f.STAR:e.lexer.next(),X(e),e.stack.push({op:"*"});break;case f.SLASH:e.lexer.next(),X(e),e.stack.push({op:"/"});break;case f.BAND:e.lexer.next(),X(e),e.stack.push({op:"BAND"});break;case f.BOR:e.lexer.next(),X(e),e.stack.push({op:"BOR"});break;case f.BXOR:e.lexer.next(),X(e),e.stack.push({op:"BXOR"});break;default:return}}function X(t){const n=t.lexer.token();switch(n.type){case f.DOT:return t.lexer.next(),function(t){return t.lexer.isLookahead(f.LEFT_PARENT)?function(t){const n=t.lexer.token().value;if(s=n,void 0===B[s])throw new e(`TERM: Unknown function "${n}"`);var s;t.lexer.next(),t.lexer.next();const r=function(e){return B[e]?.parmCount}(n),o=function(e){return B[e]?.flags}(n);let i=0;do{const e={...t,stack:[],flags:o};G(e),t.stack.push(e.stack),i++}while(t.lexer.isToken(f.COMMA)&&t.lexer.next());if(!t.lexer.isToken(f.RIGHT_PARENT))throw new e('TERM: Syntax Error: Missing ")"');if(i!==r)throw new e(`TERM: Wrong number of parameters for function "${n}". Expected ${r} Got ${i}`);t.stack.push({op:"FN",fn:n,parmCount:i}),t.lexer.next()}(t):function(t){const n=t.lexer.token().value;t.stack.push(function(t,n){switch(n){case"CPU":return{type:f.STRING,value:t.cpu};case"SEGMENTSIZE":{const e=t.code.segment();return{type:f.NUMBER,value:e.end-e.start+1}}case"SEGMENTEND":return{type:f.NUMBER,value:t.code.segment().end};case"SEGMENTSTART":return{type:f.NUMBER,value:t.code.segment().start};case"SEGMENTNAME":return{type:f.STRING,value:t.code.segment().name};case"NAMESPACE":case"NS":return{type:f.STRING,value:t.symbols.namespace};default:throw new e(`Unknown variable "${n}"`)}}(t,n)),t.lexer.next()}(t)}(t);case f.LEFT_PARENT:{t.lexer.next();const n={...t,stack:[]};if(G(n),t.stack.push(n.stack),!t.lexer.isToken(f.RIGHT_PARENT))throw new e('TERM: Syntax Error: Missing ")"');t.lexer.next();break}case f.MINUS:t.lexer.next(),X(t),t.stack.push({op:"NEG"});break;case f.BANG:if(Y(t))break;t.lexer.next(),X(t),t.stack.push({op:"!"});break;case f.GREATER:t.lexer.next(),X(t),t.stack.push({op:"MSB"});break;case f.LOWER:t.lexer.next(),X(t),t.stack.push({op:"LSB"});break;case f.AT:{if(t.lexer.next(),!t.lexer.isToken(f.IDENTIFIER))throw new e("TERM: Syntax Error in Cheap Label Name");const n=t.lexer.token().value,s=t.symbols.getCheap(t.lastLabel,n);if(!s)throw new e("TERM: Unknown Cheap Label");t.lexer.next(),t.stack.push(s);break}default:if(n.type===f.COLON&&Y(t))return;if(t.endSet?.has(n.type))return;!function(t){const n=t.lexer.token();switch(t.lexer.next(),n.type){case f.NUMBER:case f.STRING:t.stack.push(n);break;case f.IDENTIFIER:!function(t,n){let r=n.value,o=null;const i=t.pass>1&&!t.flags?.allowUndef,a=[f.DOT,f.LEFT_BRACKET];t.lexer.isToken(f.DOT)&&!t.symbols.exists(r)&&t.symbols.nsExists(r)&&(o=r,t.lexer.next(),r=t.lexer.token().value,t.lexer.next());if(i&&!t.symbols.exists(r,o)){const n=t.symbols.search(r);let s=`IDENTIFIER : Unknown identifier "${r}" in ${o||t.symbols.namespace}`;throw n.length&&(s+=`\nBut "${r}" exists in ${n.join(", ")}`),new e(s)}let c=t.symbols.get(r,o);for(;t.lexer.match(a);)switch(t.lexer.token().type){case f.DOT:{if(t.lexer.next(),c&&c.type!==f.OBJECT)throw new e(`IDENTIFIER : Not an object: "${r}"`);if(!t.lexer.isToken(f.IDENTIFIER))throw new e(`IDENTIFIER : Invalid field name: "${t.lexer.token().text}"`);r=t.lexer.token().text;const n=c?.value[r];if(c&&void 0===n)throw new e(`IDENTIFIER : Unknown Object field: "${r}"`);c={type:c?y(n):f.NUMBER,value:n},t.lexer.next();break}case f.LEFT_BRACKET:{if(c&&c.type!==f.ARRAY)throw new e(`IDENTIFIER : Not an array ${o?`${o}.`:""}${r}`);t.lexer.next();const n=P(t,new Set([f.RIGHT_BRACKET]),f.NUMBER);if(!t.lexer.isToken(f.RIGHT_BRACKET))throw new e(`IDENTIFIER : Missing close bracket ${o?`${o}.`:""}${r}`);if(t.lexer.next(),n.value>=c?.value.length)throw new e(`IDENTIFIER : Array index ${n.value} out of bounds LEN:${c.value.length}`);const i=c?.value[n.value];c=i instanceof s?i:{type:y(i),value:i};break}}t.stack.push(c?{type:c.type,value:c.value}:{type:f.NUMBER,value:void 0})}(t,n);break;case f.STAR:{const e=t.code.pc;t.stack.push({type:f.NUMBER,value:e});break}default:throw new e(`NUMBER : Syntax Error ${n}`)}}(t)}}function Y(e){if(!e.lexer.lookahead()||!D.has(e.lexer.lookahead().type))return!1;e.lexer.next();const t=e.lexer.token().type;let n=0;for(;e.lexer.isToken(t);)n++,e.lexer.next();t===f.MINUS&&(n=-n);const s=e.symbols.findClosestMarker(e.code.pc,n);return e.stack.push({value:s,type:f.NUMBER}),!0}const j="IF",Z="ELSE",W="REPEAT",V="DEFINE",z="MACRO",K="OPT",J="OPTION",Q="TEXT",q="CSTR",ee="CSTRING",te="ASCIIZ",ne="PSTR",se="PSTRING",re="PSTRL",oe="PSTRINGL",ie="END",ae="OUT",ce="ECHO",le="LOG",he="WARNING",ue="ERROR",xe="LST",pe="LIST",fe="LISTING",Ee="CPU",de="SETCPU",ke="PROCESSOR",we="ORG",Te="SEGMENT",Re="ALIGN",Ne="FILL",Ie="DS",ye="RES",me="HEX",Se="DB",ve="BYTE",Ce="DW",Ae="WORD",Oe="DL",be="LONG",Me="DBYTE",Le="DWORD",ge="INCLUDE",Be="NAMESPACE",Ue="EXPORT",De={};function Pe(e){return e.lexer.token().type===f.DOT&&e.lexer.isLookahead(f.IDENTIFIER)}const $e=[f.COLON,f.BANG];function Ge(e,t){return e.isToken(f.DOT)&&e.isLookahead(f.IDENTIFIER)&&e.lookahead().value===t}function Fe(e,n){let s="";const r=[];let o=1;for(;!e.lexer.eof();){if(e.lexer.nextLine(),$e.includes(e.lexer.token().type))e.lexer.next();else if(e.lexer.token().type===f.IDENTIFIER)e.lexer.next(),e.lexer.token().type===f.COLON&&e.lexer.next();else if(e.lexer.token().type===f.AT){if(e.lexer.next(),e.lexer.token().type!==f.IDENTIFIER)throw new t("LABEL: Cheap label without name");e.lexer.next()}if(Pe(e)&&(i=e.lexer.lookahead().value,De[i]&&De[i].isBlock)&&o++,Ge(e.lexer,n)&&1===o)r.push(""===s?void 0:s),s="";else{if(Ge(e.lexer,"END")&&(e.lexer.next(),e.lexer.next(),o--,!o))break;s+=`${e.lexer.line()}\n`}}var i;if(o>0)throw new t("BLOCK: Missing .end");return r.push(""===s?void 0:s),r}function _e(e){const t=e.lexer.token();return t.type===f.IDENTIFIER&&void 0!==e.macros[t.value]}function He(e){const n=e.macros[e.lexer.token().value],s=n.parms.length;e.lexer.next();if((n.hasRestParm?n.parms.slice(0,-1):n.parms).forEach(((n,s)=>{let r=null;if(e.lexer.token()){if(s>0){if(!e.lexer.isToken(f.COMMA))throw new t("MACRO: Syntax Error; Missing comma");e.lexer.next()}r=P(e,new Set([f.COMMA]))}e.symbols.override(n,r)})),n.hasRestParm){if(n.parms.length>1){if(!e.lexer.isToken(f.COMMA))throw new t("MACRO: Syntax Error; Missing comma");e.lexer.next()}const s=n.parms[n.parms.length-1],r=[];do{const n=P(e,new Set([f.COMMA]));if(e.lexer.token()&&!e.lexer.isToken(f.COMMA))throw new t("MACRO: Syntax Error; Missing comma");e.lexer.next(),r.push(n)}while(e.lexer.token());e.symbols.override(s,{type:f.ARRAY,value:r})}e.lexer.pushSource(n.block),s&&e.lexer.addEventListener(p.EOS,(()=>{n.parms.forEach((t=>{e.symbols.restore(t)}))}))}function Xe(e){return e.lexer.next(),e.symbols.addMarker(e.code.pc),null}function Ye(e,n=!1){const s=e.lexer.token().value;let r={type:f.NUMBER,value:e.code.pc};if(n){if(e.lexer.next(),e.lexer.isToken(f.COLON)&&e.lexer.next(),e.pass>1)return null;if(!e.symbols.addCheap(e.lastLabel,s,r))throw new VAExprError("Duplicate Cheap Label");return null}switch(e.lexer.lookahead()?e.lexer.lookahead().type:void 0){case f.EQUAL:return e.lexer.next(),e.lexer.next(),r=P(e),e.symbols.set(s,r),null;case f.COLON:if(e.lexer.next(),e.lexer.next(),1===e.pass){if(e.symbols.exists(s))throw new t(`Duplicate Symbol : ${s}`);e.symbols.set(s,r)}return s;default:if(void 0!==e.opcodes[s]||_e(e))return null;if(1===e.pass){if(e.symbols.exists(s))throw new t(`Duplicate Symbol : ${s}`);e.symbols.set(s,r)}return e.lexer.next(),s}}const je={IMPLICIT:0,IMMEDIATE:1,ABSOLUTE:2,ABSOLUTEX:3,ABSOLUTEY:4,ZP:5,ZPX:6,ZPY:7,INDIRECT:8,INDIRECTZPX:9,INDIRECTZPY:10,RELATIVE:11,ABSINDIRECTX:12,INDIRECTZP:13};function Ze(e){let n=0,s=e.lexer.token();const r=s.value,o=e.opcodes[r];if(null==o)throw new t(`OPCODE: Unknown ${e.cpu} opcode ${r} - ${e.lastLabel}`);if(e.lexer.next(),s=e.lexer.token(),s.type===f.DOT&&!s.hasSpaceBefore){if(e.lexer.next(),s=e.lexer.token(),s.type!==f.IDENTIFIER)throw new t("OPCODE: Invalid data size; needs .w or .b");switch(s.value){case"B":n=8;break;case"W":n=16;break;default:throw new t("OPCODE: Invalid data size; needs .w or .b")}e.lexer.next(),s=e.lexer.token()}if(!s){const n=o[je.IMPLICIT];if(-1===n)throw new t(`OPCODE: Invalid Address Mode for Opcode ${r}`);return e.code.emits(e.pass,[n]),!0}if(s.type===f.HASH){const s=o[je.IMMEDIATE];if(-1===s)throw new t(`OPCODE: Invalid Address Mode for Opcode ${r}`);e.lexer.next();const i=P(e,null,f.NUMBER);if(i.value>255||16===n)throw new t("OPCODE: Absolute value must by 8 bits wide");return e.code.emits(e.pass,[s,i.value]),!0}if(s.type===f.LEFT_PARENT){e.lexer.next();const s=P(e,new Set([f.COMMA,f.RIGHT_PARENT]),f.NUMBER);let i=-1;switch(e.lexer.token().type){case f.RIGHT_PARENT:if(e.lexer.next(),!e.lexer.token()){16!==n&&s.value<256&&-1!==o[je.INDIRECTZP]?(i=o[je.INDIRECTZP],n=8):8!==n&&(i=o[je.INDIRECT],n=16);break}if(!e.lexer.isToken(f.COMMA))throw new t("OPCODE: Unknown addressing mode");if(e.lexer.next(),!e.lexer.isIdentifier("Y"))throw new t("OPCODE: Unknown addressing mode");e.lexer.next(),16!==n&&s.value<256&&(i=o[je.INDIRECTZPY],n=8);break;case f.COMMA:if(e.lexer.next(),!e.lexer.isIdentifier("X"))break;if(e.lexer.next(),!e.lexer.isToken(f.RIGHT_PARENT))throw new t("OPCODE: missing closing parenthesis");e.lexer.next(),16!==n&&s.value<256?(n=8,i=o[je.INDIRECTZPX]):8!==n&&(i=o[je.ABSINDIRECTX],n=16)}if(-1===i)throw new t(`OPCODE: IAM2 Invalid Address Mode for Opcode ${r}`);const a=[i];return a.push(255&s.value),16===n&&a.push(s.value>>8&255),e.code.emits(e.pass,a),!0}const i=P(e,null,f.NUMBER);if(2===e.pass&&void 0===i.value)throw new t(`OPCODE(${e.pass}): Target Address is undefined for Opcode ${r}`);let a=-1;if(e.lexer.token()){if(e.lexer.isToken(f.COMMA)){e.lexer.next();const s=e.lexer.token();if(s.type!==f.IDENTIFIER)throw new t(`OPCODE: IAM3 Invalid Address Mode for Opcode ${r}`);switch(s.value){case"X":16!==n&&i.value<256&&-1!==o[je.ZPX]?(a=o[je.ZPX],n=8):8!==n&&(a=o[je.ABSOLUTEX],n=16);break;case"Y":16!==n&&i.value<256&&-1!==o[je.ZPY]?(a=o[je.ZPY],n=8):8!==n&&(a=o[je.ABSOLUTEY],n=16)}e.lexer.next()}}else{if(16!==n)if(-1!==o[je.RELATIVE]){if(a=o[je.RELATIVE],n=8,i.value-=e.code.pc+2&65535,2===e.pass&&(i.value<-128||i.value>127))throw new t(`OPCODE: Target Address is out of range for Opcode ${r} ${i.value}`)}else i.value<256&&-1!==o[je.ZP]&&(a=o[je.ZP],n=8);8!==n&&(a=o[je.ABSOLUTE],n=16)}if(-1===a)throw new t(`OPCODE: IAM4 Invalid Address Mode for Opcode ${r} ${n}`);var c;return 8===n?e.code.emits(e.pass,[a,I(i.value)]):e.code.emits(e.pass,[a,I(i.value),(c=i.value,c>>8&255)]),!0}function We(e){if(e.lexer.next(),!e.lexer.isToken(f.EQUAL))throw new t("ORG: Syntax Error");e.lexer.next();const n=P(e);if(n.type!==f.NUMBER)throw new t("ORG: Need an address");e.code.setPC(n.value)}const Ve=["CSTRING","CSTR","ASCIIZ"],ze=["PSTRING","PSTR","PSTRINGL","PSTRL"],Ke=["PSTRINGL","PSTRL"];function Je(e,n,s){const r=[];let o;for(let i=0;i<n.length;i++){if(s?.charSize<0)for(let e=1;e<-s.charSize;e++)r.push(0);if(o=n.charCodeAt(i),o>=256)throw new t(`STRING: Invalid character ${n[i]}`);if(92===o){if(i++,i>=n.length)throw new t(`STRING: Invalid character ${n[i-1]}`);switch(n[i]){case"\\":o="\\".charCodeAt(0);break;case"n":o="\n".charCodeAt(0);break;case"r":o="\r".charCodeAt(0);break;case"t":o="\t".charCodeAt(0);break;case"b":o="\b".charCodeAt(0);break;case"f":o="\f".charCodeAt(0);break;case"'":o="'".charCodeAt(0);break;case'"':o='"'.charCodeAt(0);break;case"0":o=0;break;case"x":{if(i+=2,i>=n.length)throw new t(`STRING: Invalid character ${n[i-2]}`);const e=n.slice(i-1,i+1);if(o=parseInt(`0x${e}`,16),isNaN(o))throw new t(`STRING: Invalid hexa value ${e}`);break}default:throw new t(`STRING: Invalid character ${n[i]}`)}}if(e?.charMap&&(o=e.charMap[o]),r.push(o),s?.charSize>0)for(let e=1;e<s.charSize;e++)r.push(0)}if(s?.hasTrailingZero&&r.push(0),s?.hasLeadingLength){const e=r.length;2===s?.lengthSize&&r.unshift((65280&e)>>8),r.unshift(255&e)}return r}const Qe={DS:1,DB:1,BYTE:1,DW:2,WORD:2,DL:4,LONG:4,DBYTE:-2,DWORD:-4},qe=/[0-9a-fA-F]/,et=/\s/,tt=/\s*;.*?$/;function nt(e,n){const s=[];let r=0;const o=()=>{if(r>=i.length)return!1;const e=i[r++];if(et.test(e))return!1;if(!qe.test(e))throw new t("Invalid character in Hex data");return e},i=e.replace(tt,"");for(;r<i.length;){const e=o();if(null===e)break;if(!1===e)continue;const t=o(),n=e+(!1!==t?t:"");s.push(Number.parseInt(n,16))}if(!n&&0===s.length)throw new t("HEX(1): Missing Hex data");return s}function st(e,n,s){const r=Math.abs(s);let o=n.value;o&=4===r?4294967295:65535;const i=o>>24&255,a=o>>16&255,c=o>>8&255,l=255&o;switch(s){case 1:if(n.value>255)throw new t("Data Overflow - 8bits expected");e.push(l);break;case 2:if(n.value>65535)throw new t("Data Overflow - 16bits expected");e.push(l,c);break;case 4:e.push(l,c,a,i);break;case-4:e.push(i,a,c,l);break;case-2:e.push(c,l)}}const rt={ADC:[-1,105,109,125,121,101,117,-1,-1,97,113,-1,-1,-1],AND:[-1,41,45,61,57,37,53,-1,-1,33,49,-1,-1,-1],ASL:[10,-1,14,30,-1,6,22,-1,-1,-1,-1,-1,-1,-1],BCC:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,144,-1,-1],BCS:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,176,-1,-1],BEQ:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,240,-1,-1],BIT:[-1,-1,44,-1,-1,36,-1,-1,-1,-1,-1,-1,-1,-1],BMI:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,48,-1,-1],BNE:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,208,-1,-1],BPL:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,16,-1,-1],BRK:[0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],BVC:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,80,-1,-1],BVS:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,112,-1,-1],CLC:[24,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],CLD:[216,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],CLI:[88,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],CLV:[184,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],CMP:[-1,201,205,221,217,197,213,-1,-1,193,209,-1,-1,-1],CPX:[-1,224,236,-1,-1,228,-1,-1,-1,-1,-1,-1,-1,-1],CPY:[-1,192,204,-1,-1,196,-1,-1,-1,-1,-1,-1,-1,-1],DEC:[-1,-1,206,222,-1,198,214,-1,-1,-1,-1,-1,-1,-1],DEX:[202,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],DEY:[136,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],EOR:[-1,73,77,93,89,69,85,-1,-1,65,81,-1,-1,-1],INC:[-1,-1,238,254,-1,230,246,-1,-1,-1,-1,-1,-1,-1],INX:[232,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],INY:[200,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],JMP:[-1,-1,76,-1,-1,-1,-1,-1,108,-1,-1,-1,-1,-1],JSR:[-1,-1,32,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],LDA:[-1,169,173,189,185,165,181,-1,-1,161,177,-1,-1,-1],LDX:[-1,162,174,-1,190,166,-1,182,-1,-1,-1,-1,-1,-1],LDY:[-1,160,172,188,-1,164,180,-1,-1,-1,-1,-1,-1,-1],LSR:[74,-1,78,94,-1,70,86,-1,-1,-1,-1,-1,-1,-1],NOP:[234,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],ORA:[-1,9,13,29,25,5,21,-1,-1,1,17,-1,-1,-1],PHA:[72,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],PHP:[8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],PLA:[104,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],PLP:[40,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],ROL:[42,-1,46,62,-1,38,54,-1,-1,-1,-1,-1,-1,-1],ROR:[106,-1,110,126,-1,102,118,-1,-1,-1,-1,-1,-1,-1],RTI:[64,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],RTS:[96,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],SBC:[-1,233,237,253,249,229,245,-1,-1,225,241,-1,-1,-1],SEC:[56,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],SED:[248,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],SEI:[120,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],STA:[-1,-1,141,157,153,133,149,-1,-1,129,145,-1,-1,-1],STX:[-1,-1,142,-1,-18,134,-1,150,-1,-1,-1,-1,-1,-1],STY:[-1,-1,140,-17,-1,132,148,-1,-1,-1,-1,-1,-1,-1],TAX:[170,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],TAY:[168,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],TSX:[186,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],TXA:[138,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],TXS:[154,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],TYA:[152,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]},ot={...rt,BRA:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,128,-1,-1],STZ:[-1,-1,156,158,-1,100,116,-1,-1,-1,-1,-1,-1,-1],PHX:[218,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],PLX:[250,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],PHY:[90,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],PLY:[122,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],TRB:[-1,-1,28,-1,-1,20,-1,-1,-1,-1,-1,-1,-1,-1],TSB:[-1,-1,12,-1,-1,4,-1,-1,-1,-1,-1,-1,-1,-1],BBR:[-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1],BBS:[-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1],RMB:[-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1],SMB:[-1,-1,-1,-1,-1,0,-1,-1,-1,-1,-1,-1,-1,-1],INA:[26,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],DEA:[58,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],BIT:[-1,137,44,60,-1,36,52,-1,-1,-1,-1,-1,-1,-1],ADC:[-1,105,109,125,121,101,117,-1,-1,97,113,-1,-1,114],AND:[-1,41,45,61,57,37,53,-1,-1,33,49,-1,-1,50],CMP:[-1,201,205,221,217,197,213,-1,-1,193,209,-1,-1,210],EOR:[-1,73,77,93,89,69,85,-1,-1,65,81,-1,-1,82],LDA:[-1,169,173,189,185,165,181,-1,-1,161,177,-1,-1,178],ORA:[-1,9,13,29,25,5,21,-1,-1,1,17,-1,-1,18],SBC:[-1,233,237,253,249,229,245,-1,-1,225,241,-1,-1,242],STA:[-1,-1,141,157,153,133,149,-1,-1,129,145,-1,-1,146],JMP:[-1,-1,76,-1,-1,-1,-1,-1,108,-1,-1,-1,124,-1]},it={...rt,ALR:[-1,75,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],ANC:[-1,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],ANC2:[-1,43,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],ANE:[-1,139,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],ARR:[-1,107,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],DCP:[-1,-1,207,223,219,199,215,-1,-1,195,211,-1,-1],ISC:[-1,-1,239,255,251,231,247,-1,-1,227,243,-1,-1],LAS:[-1,-1,-1,-1,187,-1,-1,-1,-1,-1,-1,-1,-1],LAX:[-1,171,175,-1,191,167,-1,183,-1,163,179,-1,-1],LXA:[-1,171,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],NOP:[234,128,12,28,-1,4,20,-1,-1,-1,-1,-1,-1],RLA:[-1,-1,47,63,59,39,55,-1,-1,35,51,-1,-1],RRA:[-1,-1,111,127,123,103,119,-1,-1,99,115,-1,-1],SAX:[-1,-1,143,-1,-1,135,-1,151,-1,131,-1,-1,-1],USBC:[-1,235,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],SBX:[-1,203,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],SHA:[-1,-1,-1,-1,159,-1,-1,-1,-1,-1,147,-1,-1],SHX:[-1,-1,-1,-1,158,-1,-1,-1,-1,-1,-1,-1,-1],SHY:[-1,-1,-1,156,-1,-1,-1,-1,-1,-1,-1,-1,-1],SLO:[-1,-1,15,31,27,7,23,-1,-1,3,19,-1,-1],SRE:[-1,-1,79,95,91,71,87,-1,-1,67,83,-1,-1],TAS:[-1,-1,-1,-1,155,-1,-1,-1,-1,-1,-1,-1,-1],JAM:[2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],DOP:[-1,128,-1,-1,-1,4,20,-1,-1,-1,-1,-1,-1],TOP:[-1,-1,12,28,-1,-1,-1,-1,-1,-1,-1,-1,-1]},at={cpu6502:"6502",cpu65X02:"65X02",cpu65C02:"65C02"};function ct(e,n){const s=n.toUpperCase();switch(s){case at.cpu6502:e.opcodes=rt;break;case at.cpu65X02:e.opcodes=it;break;case at.cpu65C02:e.opcodes=ot;break;default:throw new t("Unknown cpu name")}e.cpu=at[`cpu${s}`]}function lt(e,n,s){if(void 0===e)throw new t(`PRAGMA: no handler defined for ${s.join(",")}`);s.forEach((s=>{if(Object.hasOwn(De,s))throw new t(`PRAGMA: "${s}" already defined`);De[s]={handlerFn:e,isBlock:n}}))}function ht(e){e.lexer.next();const n=e.lexer.token();if(!n)return!1;const s=De[n.value];if(!s)throw new t("PRAGMA: Unknown pragma");if(!s.handlerFn)throw new t("PRAGMA: Syntax Error");e.lexer.next();return!!s.handlerFn(e,n.value)}lt((function(e,n){const s=P(e);if(s.type!==f.NUMBER)throw new t("Need a number");e.lexer.line();const[r,o]=Fe(e,"ELSE"),i=s.value?r:o;return i&&e.lexer.pushSource(i),!0}),!0,[j]),lt(null,!1,[Z]),lt((function(e){const n=P(e);if(n.type!==f.NUMBER)throw new t("Need a number");let s=null;e.lexer.isToken(f.IDENTIFIER)&&(s=e.lexer.token(),e.lexer.next());const[r]=Fe(e);let o;if(s){const t=s.value,r={type:f.NUMBER,value:0};e.symbols.override(t,r),o=()=>{r.value++,r.value>=n.value&&e.symbols.restore(s.value)}}for(let t=0;t<n.value;t++)e.lexer.pushSource(r),s&&e.lexer.addEventListener(p.EOS,o);return!0}),!0,[W]),lt((function(e){const n=e.lexer.token().value,[s]=Fe(e);let r;try{r=e.YAMLparse(s.replace(/\t/g," "))}catch(e){throw new t(`Invalid YAML/JSON : ${e.message}`)}if(1===e.pass&&e.symbols.exists(n))throw new t(`Duplicate Symbol : ${n}`);return e.symbols.set(n,{type:y(r),value:r}),!0}),!0,[V]),lt((function(e,n){const s={parms:[],block:null,hasRestParm:!1};if(!e.lexer.isToken(f.IDENTIFIER))throw new t("MACRO: Need a name");const r=e.lexer.token().value.toUpperCase();for(e.lexer.next();e.lexer.match([f.IDENTIFIER,f.REST]);){e.lexer.isToken(f.REST)&&(e.lexer.next(),s.hasRestParm=!0);const n=e.lexer.token().value;if(s.parms.push(n),e.lexer.next(),!e.lexer.token())break;if(!e.lexer.isToken(f.COMMA))throw new t("MACRO: Syntax Error; Needs a comma beween parameter");e.lexer.next()}const[o]=Fe(e);if(s.block=o,1===e.pass){if(void 0!==e.macros[r])throw new t(`MACRO: "${r}" is already defined`);e.macros[r]=s}}),!0,[z]),lt((function(e,n){const s=e.lexer.token().value;switch(e.lexer.next(),s){case"CHARMAP":{if(!e.lexer.isToken(f.IDENTIFIER))throw new t("OPTION: need a defined charmap name");const n=e.lexer.token().value;if(e.lexer.next(),"NONE"===n){e.charMap=null;break}const s=`CHARMAP_${n}`;let r=e.symbols.get(s);if(r||(r=e.symbols.get(s,S)),!r)throw new t(`OPTION: unknown charmap ${n}`);if(r.type!==f.ARRAY)throw new t(`OPTION: invalid charmap ${N(r.type)}, need an array`);if(256!==r.value.length)throw new t("OPTION: invalid charmap, need 256 values");e.charMap=r.value;break}default:throw new t(`OPTION: unknown option ${s}`)}return!0}),!1,[K,J]),lt((function(e,n){const s={hasTrailingZero:Ve.includes(n),hasLeadingLength:ze.includes(n),lengthSize:Ke.includes(n)?2:1,charSize:1};if(!e.lexer.token())throw new t("STRING: missing a string here");for(;e.lexer.token();){const n=P(e,new Set([f.COMMA]));switch(n.type){case f.STRING:{const t=Je(e,n.value,s);e.code.emits(e.pass,t,!0);break}default:throw new t(`STRING: Invalid Type "${n.type}". Must be a string`)}if(!e.lexer.isToken(f.COMMA))return!1;e.lexer.next()}return!0}),!1,[Q,ee,q,te,se,ne,oe,re]),lt((function(e){if(e.lexer.token()){if(!e.lexer.isIdentifier(Be))throw new t("END: Syntax error");return e.symbols.nsPop(),e.lexer.next(),!0}return e.lexer.stopSource(),!0}),!1,[ie]),lt((function(e,n){let s="";do{const n=P(e);if(s+="object"==typeof n.value?JSON.stringify(n.value):n.value,e.lexer.isToken(f.COMMA)&&(e.lexer.next(),!e.lexer.token()))throw new t("OUT: Missing value here")}while(!1!==e.lexer.token());switch(n){case"OUT":case"ECHO":case"LOG":e.print(s,!0);break;case"WARNING":e.warn(s);break;case"ERROR":throw new t(s)}}),!1,[ae,ce,le,he,ue]),lt((function(e){if(!e.lexer.isToken(f.IDENTIFIER))throw new t("Needed a ON or OFF here");switch(e.lexer.token().value){case"ON":e.wannaListing=!0;break;case"OFF":e.wannaListing=!1;break;default:throw new t("Needed a ON or OFF here")}e.lexer.next()}),!1,[xe,pe,fe]),lt((function(e){const n=e.lexer.token();if(n.type!==f.STRING)throw new t("Need cpu name string");ct(e,n.value),e.lexer.next()}),!1,[Ee,de,ke]),lt((function(e){const n=P(e);if(n.type!==f.NUMBER)throw new t("ORG: Need an address");e.code.setPC(n.value)}),!1,[we]),lt((function(e){const n=e.lexer.token();if(n.type!==f.IDENTIFIER)throw new t("Need a segment name");return e.lexer.next(),e.code.select(n.value),!0}),!1,[Te]),lt((function(e){const n=P(e);if(n.type!==f.NUMBER)throw new t("Need a number");const s=65535&n.value,r=e.code.pc%s;let o=0;if(e.lexer.isToken(f.COMMA)){e.lexer.next();const n=P(e);if(n.type!==f.NUMBER)throw new t("Need a number");o=n.value}const i=Array.from({length:s-r},(()=>o));e.code.emits(e.pass,i)}),!1,[Re]),lt((function(e){const n=P(e);if(n.type!==f.NUMBER)throw new t("Need a number");const s=65535&n.value;let r=0;if(e.lexer.isToken(f.COMMA)){e.lexer.next();const n=P(e);if(n.type!==f.NUMBER)throw new t("Need a number");r=n.value}const o=Array.from({length:s},(()=>r));e.code.emits(e.pass,o)}),!1,[Ne,ye,Ie]),lt((function(e,n){if(e.lexer.token()){const t=e.lexer.line().slice(e.lexer.token().posInLine);for(e.code.emits(e.pass,nt(t,!1));e.lexer.next(););}else e.code.emits(e.pass,function(e){const n=[];for(;;){if(e.lexer.nextLine(),e.lexer.eof())throw new t("Missing .end for .hex");if(e.lexer.isToken(f.DOT)){if(e.lexer.next(),!e.lexer.isIdentifier("END"))throw new t("Illegal pragma here");e.lexer.next();break}const s=e.lexer.line().trim();s.length&&n.push(...nt(s,!0))}if(0===n.length)throw new t("HEX(2): Missing Hex data");return n}(e))}),!1,[me]),lt((function(e,n){const s=Qe[n];let o=[];for(;;){const n=P(e);switch(n.type){case f.NUMBER:st(o,n,s);break;case f.STRING:o=o.concat(Je(e,n.value,{charSize:s}));break;default:throw new t(`DATA: Invalid Type "${r(n.type)}". Must be a string or a number`)}if(!e.lexer.isToken(f.COMMA))break;e.lexer.next()}if(0===o.length)throw new t("Missing data");e.code.emits(e.pass,o)}),!1,[Se,ve,Ce,Ae,Oe,be,Me,Le]),lt((function(e){const n=P(e);if(n.type!==f.STRING)throw new t("Need a filename");if(e.lexer.isIdentifier("ASBIN")){const{content:t}=e._readFile(n.value,e.filename,!0);e.code.emits(e.pass,t),e.lexer.next()}else e.pushFile(n.value,e.filename)}),!1,[ge]),lt((function(e){let n=null;if(e.lexer.token()){if(!e.lexer.isToken(f.IDENTIFIER))throw new t("Need a namespace name");n=e.lexer.token().value}e.symbols.select(n),e.lexer.next()}),!1,[Be]),lt((function(e){const n=e.lexer.token();if(!e.symbols.isGlobal)switch(n.type){case f.IDENTIFIER:if(2===e.pass&&!e.symbols.exists(n.value))throw new t("EXPORT: Unknown symbol");e.symbols.export(n.value);break;case f.STRING:if(!e.symbols.exportMany(n.value))throw new t("EXPORT: No match so nothing to export");break;default:throw new t("EXPORT: Need a symbol name or regex")}e.lexer.next()}),!1,[Ue]);const ut=32;function xt(e,t){const n=new b(t,e);let s=at.cpu6502;t.cpu&&Object.values(at).includes(t.cpu.toUpperCase())&&(s=t.cpu.toUpperCase()),ct(n,s);try{pt(n)}catch(e){throw e?.name?.match(/^VA/)&&n.error(e.message),e}n.reset(),n.pass=2;try{pt(n)}catch(e){throw e?.name?.match(/^VA/)&&n.error(e.message),e}return{symbols:n.symbols,segments:n.code.segments,obj:n.code.obj,dump:n.code.dump}}function pt(e){for(;!e.wannaStop&&e.lexer.nextLine();){const n=e.lexer.token();if(!n)continue;if(n.type===f.INVALID)throw new t(`Invalid character ${n.value}`);const s=e.lexer.line();let r=null;const o=t=>{switch(t.type){case f.BANG:case f.COLON:return Xe(e);case f.IDENTIFIER:return Ye(e);case f.AT:return e.lexer.isLookahead(f.IDENTIFIER)?(e.lexer.next(),Ye(e,!0)):null}};for(;;){if(e.lexer.isToken(f.STAR)){We(e);break}if(r=o(n),r&&(e.lastLabel=r),Pe(e)){ht(e);break}if(_e(e)){He(e);break}e.lexer.isToken(f.IDENTIFIER)&&Ze(e);break}if(e.lexer.token())throw new t(`Syntax Error on ${e.lexer.token().text}`);if(2===e.pass){r&&e.print(`${r}:`);let t="";const n=e.code.output,o=n?.length>ut;n&&!o&&(t+=n),t=t.padEnd(18),t+=s,n&&o&&(t+=`\n${n}`),e.print(t)}}e.wannaStop=!1}export{xt as assemble};
